<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Front Hero: YouTube Stats</title>
</head>
<body>

    <div id="feh-youtube-stats-wrapper">
        <h1>Frontend Hero Stats</h1>
        <p>Last updated: <span id="feh-cache-time"></span></p>

        <div id="feh-youtube-stats">
            <div class="feh-stats">
                <h3>Subscribers</h3>
                <p id="feh-subs"></p>
            </div>
            <div class="feh-stats">
                <h3>Views</h3>
                <p id="feh-views"></p>
            </div>
            <div class="feh-stats">
                <h3>Videos</h3>
                <p id="feh-videos"></p>
            </div>
        </div>
    </div>

    <script>
        (function() {

            const channelId = 'UCwJBZg7Udi8mVuEHYQ5iB0g';
            const apiKey = 'AIzaSyD7DIt2F0fr9WfAkddhRucRFH2DdRtIYLY';
            const cacheMins = 5;


            /** 
             * Try to load cached data first or created empty object
             */
            let cache;
            try {
                cache = JSON.parse(localStorage.getItem('feh-yt-cache')) || { data: null, time: 0 };
            } catch (error) {
                cache = { data: null, time: 0 }; 
            }


            /** 
             * Check cache
             */
            function isCacheValid() {
                return cache.data && (Date.now() - cache.time) < cacheMins * 60000;
            }


            /** 
             * Format numbers
             */
            function formatNumber(n) {
                return parseInt(n).toLocaleString();
            }


            /** 
             * Update stats
             */
            function updateStats(stats, timestamp = cache.time) {
                document.getElementById('feh-subs').textContent = formatNumber(stats.subscriberCount); 
                document.getElementById('feh-views').textContent = formatNumber(stats.viewCount);
                document.getElementById('feh-videos').textContent = formatNumber(stats.videoCount);

                const timeEl = document.getElementById('feh-cache-time');
                timeEl.textContent = new Date(timestamp).toLocaleTimeString();
            }


            /** 
             * Fetch YouTube Data
             */
            async function fetchStats() {

                if(isCacheValid()) {
                    updateStats(cache.data, cache.time);
                    return;
                }

                try {
                    const url = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${apiKey}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    const stats = data.items[0].statistics;

                    cache = { data: stats, time: Date.now() };
                    localStorage.setItem('feh-yt-cache', JSON.stringify(cache));

                    updateStats(stats, Date.now());

                } catch(error) {
                    console.error('Fetching stats error: ', error);
                }

            }

            fetchStats();
            setInterval(fetchStats, cacheMins * 60000);

        })();
    </script>

</body>
</html>